{% extends 'base.html' %}
{% load static %}

{% block title %}Perfil por expedición{% endblock %}

{% block css %}
{% endblock %}

{% block content %}
<div class="">
  <div class="page-title">
    <div class="title_left">
      <h3>Perfil de carga <small>por expedición</small></h3>
    </div>
    <div class="title_right">
      <div class="col-md-5 col-sm-5 col-xs-12 form-group pull-right top_search">
        <div class="input-group">
          <input type="text" class="form-control" placeholder="Ingresar número de expedición...">
          <span class="input-group-btn">
            <button class="btn btn-default" type="button">Cargar!</button>
          </span>
        </div>
      </div>
    </div>
  </div>

  <div class="clearfix"></div>

  <div class="row">
  <div class="col-md-9 col-sm-9 col-xs-12">
    <div class="x_panel">
      <div class="x_title">
        <h2>Perfil de carga<small>por expedición</small></h2>
        <div class="clearfix"></div>
      </div>
      <div class="x_content">
        <div id="main" style="height:350px;"></div>
      </div>
    </div>
  </div>
  <div class="col-md-3 col-xs-12 widget widget_tally_box">
   <div class="x_panel fixed_height_390">
      <div class="x_title">
        <h2>Información de expedición</h2>
        <div class="clearfix"></div>
      </div>
      <div class="x_content">
        <div class="tile-stats">
          <div class="icon"><i class="fa fa-bus"></i></div>
          <div class="count" id="route"></div>
          <h3 id="licensePlate"></h3>
        </div>
        <div class="tile-stats">
          <p>Capacidad: <strong id="capacity"></strong></p>
          <p>Hora de inicio: <strong id="timeTripInit"></strong></p>
          <p>Hora de fin: <strong id="timeTripEnd"></strong></p>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block js %}
{% with "components/gentelella/vendors/" as gentelella_static %}
<script src="{% static gentelella_static|add:"echarts/dist/echarts.min.js" %}"></script>
{% endwith %}
<script src="{% static "own/js/echartsTheme.js" %}"></script>
<script>
$(document).ready(function(){

  function updateBusInfo(route, licensePlate, capacity, timeTripInit, timeTripEnd) {
    $('#route').html(route + ' ');
    $('#licensePlate').html(licensePlate);
    $('#capacity').html(capacity);
    $('#timeTripInit').html(timeTripInit);
    $('#timeTripEnd').html(timeTripEnd);
  }

  function loadChart(data){
    var echartBar = echarts.init(document.getElementById('main'), theme);

    echartBar.setOption({
      tooltip: data.tooltip,
      legend: data.legend,
      xAxis: data.xAxis,
      yAxis: data.yAxis,
      series: data.series,
      toolbox: {
        show : true,
        feature : {
          mark : {show: false},
          restore : {show: false, title: "restaurar"},
          saveAsImage : {show: true, title: "Guardar imagen"}
        }
      },
      calculable: false,
    });
  }

  $.getJSON('getExpeditionData', {idExpedition: 64000}, function(dataSource){
    var trips = dataSource.trips;
    
    for (expeditionId in trips){
      var trip = trips[expeditionId];

      // trip info
      var capacity = trip['info']['capacity'];
      var licensePlate = trip['info']['licensePlate'];
      var route = trip['info']['route'];
      var timeTripInit = trip['info']['timeTripInit'];
      var timeTripEnd = trip['info']['timeTripEnd'];
    
      updateBusInfo(route, licensePlate, capacity, timeTripInit, timeTripEnd);
     
      // chart data
      var xAxisData = [];
      var stopName = [];
      // get out, get in, load profile, percentage ocupation
      var yAxisData = [[], [], [], []];
      var yAxisDataName = ['Bajadas', 'Subidas', 'Carga', 'Porcentaje ocupación'];
      var yAxisIndex = [0, 0, 0, 1];
      var yChartType = ['bar','bar','line','line'];
      var markLine = {
        data:[{
          yAxis: capacity
        }],
        symbol: 'rect',
        label: {
          normal: {
            formatter: 'Capacidad del bus',
            position: 'middle'
          }
        }
      };
      var yMarkLine = [{}, {}, markLine, {}];

      for(record in trip['stops']){
        xAxisData.push(trip['stops'][record]['order']);
        stopName.push(trip['stops'][record]['name']);
        yAxisData[0].push(trip['stops'][record]['expandedGetOut']);
        yAxisData[1].push(trip['stops'][record]['expandedGetIn']);
        yAxisData[2].push(trip['stops'][record]['loadProfile']);
        yAxisData[3].push((trip['stops'][record]['loadProfile']/capacity)*100);
      }
      
      var series = [];
      for (index in yAxisData){
        var serie = {
          name: yAxisDataName[index],
          type: yChartType[index],
          data: yAxisData[index],
          markPoint: {
            data: [
              {type: 'max', name: 'Máximo'}
            ],
            label: {
              normal: {
                formatter: function(param){
                  return param.value.toFixed(2);
                }
              }
            }
          },
          markLine: yMarkLine[index],
          yAxisIndex: yAxisIndex[index],
          smooth: true
        };
        series.push(serie);
      }
      
      var data = {
        legend: {
          data: yAxisDataName
        },
        xAxis: [{
          type: 'category',
          data: xAxisData
        }],
        yAxis: [{
          type: 'value',
          name: 'Pasajeros',
          //max: capacity - capacity%10 + 10,
          position: 'left',
        },{
          type: 'value',
          name: 'Porcentaje',
          min: 0,
          max: 100,
          position: 'right',
          axisLabel: {
            formatter: '{value} %'
          }
        }],
        series: series,
        tooltip: {
          trigger: 'axis',
          //alwaysShowContent: true,
          formatter: function(params){
            //console.log(params);
            if (Array.isArray(params)){
              xValue = params[0].dataIndex + 1;
              var head = xValue + ' - ' + stopName[xValue-1] + '<br />';
              var info = [];
              for (index in params){
                el = params[index]
                var ball ="<span style='display:inline-block;margin-right:5px;border-radius:10px;width:9px;height:9px;background-color:" + el.color + "'></span>";
                var name = el.seriesName;
                var value = el.value.toFixed(2);
                info.push(ball + name + ': ' + value);
              }
              return head + info.join('<br />');
            } else {
              var title = params.data.name;
              var name = params.seriesName;
              var value = params.value.toFixed(2);
              return title + '<br />' + name + ': ' + value;
            }
          }
        },
      };

      loadChart(data);
    }
  });
});
</script>
{% endblock %}
