{% extends 'base.html' %}
{% load static %}

{% block title %}Perfil por expedición{% endblock %}

{% block css %}
{% with "components/gentelella/vendors/" as gentelella_static %}
  <link href="{% static gentelella_static|add:"bootstrap-daterangepicker/daterangepicker.css" %}" rel="stylesheet">
  <link href="{% static "components/select2/dist/css/select2.min.css" %}" rel="stylesheet">
  <style>
.select2-container .select2-choice:not(.select2-default) {
    background-image: none !important;
    background-color: #D9FFC7;
}
  </style>
{% endwith %}
{% endblock %}

{% block content %}
<div class="">
  <div class="page-title">
    <div class="title_left">
      <h3>Perfil de carga <small>por expedición</small></h3>
    </div>
    <div class="title_right">
    </div>
  </div>
  <div class="clearfix"></div>
  <br />

  <div class="row">
    <div class="col-md-12 col-sm-12 col-xs-12">
      <div class="x_panel">
        <div class="x_title">
          <h2>Filtro <small></small></h2>
          <div class="clearfix"></div>
        </div>
        <div class="x_content">
          <div class="col-md-1 col-sm-12 col-xs-12 form-group">
            <label class="control-label" for="filterDateFrom">Desde:</label>
            <input type="text" id="filterDateFrom" placeholder="Desde" class="form-control">
          </div>

          <div class="col-md-1 col-sm-12 col-xs-12 form-group">
            <label class="control-label" for="filterDateTo">Hasta:</label>
            <input type="text" id="filterDateTo" placeholder="Hasta" class="form-control">
          </div>

          <div class="col-md-2 col-sm-12 col-xs-12 form-group">
            <label class="control-label" for="filterRoute">Servicio-sentido:</label>
            <input type="text" id="filterRoute" placeholder="Servicio sentido" class="form-control">
          </div>

          <div class="col-md-1 col-sm-12 col-xs-12 form-group">
            <label class="control-label" for="filterDayType">Tipo de día:</label>
            <select class="form-control" id='filterDayType' multiple="multiple">
              {% for dayType in dayTypes %}
              <option>{{ dayType }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-2 col-sm-12 col-xs-12 form-group">
            <label class="control-label" for="filterPeriod">Período:</label>
            <select class="form-control" id='filterPeriod' multiple="multiple">
              {% for period in periods %}
              <option>{{ period }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-5 col-sm-12 col-xs-12 form-group">
            <label class="control-label" for="filterLicensePlate">Patente:</label>
            <input type="text" id="filterLicensePlate" placeholder="Patente" class="tags form-control">
          </div>

          <div class="col-md-12 col-sm-12 col-xs-12 form-group">
            <div class="ln_solid"></div>
            <button type="submit" id="btnUpdateChart" class="btn btn-success btn-lg btn-round">Actualizar datos</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
  <div class="col-md-9 col-sm-9 col-xs-12">
    <div class="x_panel">
      <div class="x_title">
        <h2>Perfil de carga<small>por expedición</small></h2>
        <div class="clearfix"></div>
      </div>
      <div class="x_content">
        <div id="main" style="height:400px;"></div>
      </div>
    </div>
  </div>
  <div class="col-md-3 col-xs-12">
   <div class="x_panel">
      <div class="x_title">
        <h2>Información de expedición</h2>
        <div class="clearfix"></div>
      </div>
      <div class="x_content">
        <div class="tile-stats">
          <div class="icon"><i class="fa fa-bus"></i></div>
          <div class="count" id="route"></div>
          <h3 id="licensePlate"></h3>
        </div>
        <div class="tile-stats">
          <p>Capacidad: <strong id="capacity"></strong></p>
          <p>Hora de inicio: <strong id="timeTripInit"></strong></p>
          <p>Hora de fin: <strong id="timeTripEnd"></strong></p>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block js %}
{% with "components/gentelella/vendors/" as gentelella_static %}
<script src="{% static gentelella_static|add:"echarts/dist/echarts.min.js" %}"></script>
<script src="{% static gentelella_static|add:"moment/min/moment-with-locales.min.js" %}"></script>
<script src="{% static gentelella_static|add:"bootstrap-daterangepicker/daterangepicker.js" %}"></script>
<script src="{% static gentelella_static|add:"jquery.tagsinput/src/jquery.tagsinput.js" %}"></script>
<script src="{% static "components/select2/dist/js/select2.full.min.js" %}"></script>
{% endwith %}
<script src="{% static "own/js/echartsTheme.js" %}"></script>
<script>
$(document).ready(function(){

  function updateBusInfo(route, licensePlate, capacity, timeTripInit, timeTripEnd) {
    $('#route').html(route + ' ');
    $('#licensePlate').html(licensePlate);
    $('#capacity').html(capacity);
    $('#timeTripInit').html(timeTripInit);
    $('#timeTripEnd').html(timeTripEnd);
  }

  function loadChart(data){
    var echartBar = echarts.init(document.getElementById('main'), theme);

    echartBar.setOption({
      tooltip: data.tooltip,
      legend: data.legend,
      xAxis: data.xAxis,
      yAxis: data.yAxis,
      series: data.series,
      toolbox: {
        show : true,
        feature : {
          mark : {show: false},
          restore : {show: false, title: "restaurar"},
          saveAsImage : {show: true, title: "Guardar imagen"}
        }
      },
      calculable: false,
    });
  }

  function processData(dataSource){
    console.log(dataSource);
    var trips = dataSource.trips;
    
    for (expeditionId in trips){
      var trip = trips[expeditionId];

      // trip info
      var capacity = trip['info']['capacity'];
      var licensePlate = trip['info']['licensePlate'];
      var route = trip['info']['route'];
      var timeTripInit = trip['info']['timeTripInit'];
      var timeTripEnd = trip['info']['timeTripEnd'];
    
      updateBusInfo(route, licensePlate, capacity, timeTripInit, timeTripEnd);
     
      // chart data
      var xAxisData = [];
      var stopName = [];
      // get out, get in, load profile, percentage ocupation
      var yAxisData = [[], [], [], []];
      var yAxisDataName = ['Bajadas', 'Subidas', 'Carga', 'Porcentaje ocupación'];
      var yAxisIndex = [0, 0, 0, 1];
      var yChartType = ['bar','bar','line','line'];
      var markLine = {
        data:[{
          yAxis: capacity
        }],
        symbol: 'rect',
        label: {
          normal: {
            formatter: 'Capacidad del bus',
            position: 'middle'
          }
        }
      };
      var yMarkLine = [{}, {}, markLine, {}];

      for(record in trip['stops']){
        xAxisData.push(trip['stops'][record]['order']);
        stopName.push(trip['stops'][record]['name']);
        yAxisData[0].push(trip['stops'][record]['expandedGetOut']);
        yAxisData[1].push(trip['stops'][record]['expandedGetIn']);
        yAxisData[2].push(trip['stops'][record]['loadProfile']);
        yAxisData[3].push((trip['stops'][record]['loadProfile']/capacity)*100);
      }
      
      var series = [];
      for (index in yAxisData){
        var serie = {
          name: yAxisDataName[index],
          type: yChartType[index],
          data: yAxisData[index],
          markPoint: {
            data: [
              {type: 'max', name: 'Máximo'}
            ],
            label: {
              normal: {
                formatter: function(param){
                  return param.value.toFixed(2);
                }
              }
            }
          },
          markLine: yMarkLine[index],
          yAxisIndex: yAxisIndex[index],
          smooth: true
        };
        series.push(serie);
      }
      
      var data = {
        legend: {
          data: yAxisDataName
        },
        xAxis: [{
          type: 'category',
          data: xAxisData
        }],
        yAxis: [{
          type: 'value',
          name: 'Pasajeros',
          //max: capacity - capacity%10 + 10,
          position: 'left',
        },{
          type: 'value',
          name: 'Porcentaje',
          min: 0,
          max: 100,
          position: 'right',
          axisLabel: {
            formatter: '{value} %'
          }
        }],
        series: series,
        tooltip: {
          trigger: 'axis',
          //alwaysShowContent: true,
          formatter: function(params){
            //console.log(params);
            if (Array.isArray(params)){
              xValue = params[0].dataIndex + 1;
              var head = xValue + ' - ' + stopName[xValue-1] + '<br />';
              var info = [];
              for (index in params){
                el = params[index]
                var ball ="<span style='display:inline-block;margin-right:5px;border-radius:10px;width:9px;height:9px;background-color:" + el.color + "'></span>";
                var name = el.seriesName;
                var value = el.value.toFixed(2);
                info.push(ball + name + ': ' + value);
              }
              return head + info.join('<br />');
            } else {
              var title = params.data.name;
              var name = params.seriesName;
              var value = params.value.toFixed(2);
              return title + '<br />' + name + ': ' + value;
            }
          }
        },
      };

      loadChart(data);
    }
  };

   // load filters
  (function (){
    // set locale
    moment.locale('es');
    // set datetimepickers
    $('#filterDateFrom').daterangepicker({
      singleDatePicker: true,
      singleClasses: "picker_2",
      languague: 'es'
    });
    $('#filterDateTo').daterangepicker({
      singleDatePicker: true,
      singleClasses: "picker_2",
      languague: 'es'
    });
  
    $('#filterLicensePlate').tagsInput({height: 34, defaultText: 'patente', minChars:6});

    $('#filterDayType').select2({placeholder: 'tipo de día'});
    $('#filterPeriod').select2({placeholder: 'Periodo'});
 
    $('#btnUpdateChart').click(function(){
      var from = $('#filterDateFrom').val();
      var to = $('#filterDateTo').val();
      var route = $('#filterRoute').val();
      var licensePlate = $('#filterLicensePlate').val();
      var dayType = $('#filterDayType').val();
      var period = $('#filterPeriod').val();
   
      console.log(from);
      console.log(to);
      console.log(route);
      console.log(licensePlate);
      console.log(dayType);
      console.log(period);

      var data = {
        from: from,
        to: to,
      };
      if (route) {
        data['route'] = route;
      }
      if (licensePlate) {
        data['licensePlate'] = licensePlate;
      }    
      if (dayType) {
        data['dayType'] = dayType;
      }
      if (period) {
        data['period'] = period;
      }
      console.log(data);

      $.getJSON('getExpeditionData', data, processData);
    });
  })()
});
</script>
{% endblock %}
